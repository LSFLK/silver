version: '3.8'

services:
  # Initialize database from the image
  thunder-db-init:
    image: ghcr.io/asgardeo/thunder:0.14.0
    container_name: thunder-db-init
    command: sh -c "cp -r /opt/thunder/repository/database/* /data/"
    volumes:
      - thunder-db:/data
    restart: "no"

  # Run setup once with the shared database
  thunder-setup:
    image: ghcr.io/asgardeo/thunder:0.14.0
    container_name: thunder-setup
    command: ./setup.sh
    volumes:
      - thunder-db:/opt/thunder/repository/database
    depends_on:
      thunder-db-init:
        condition: service_completed_successfully
    restart: "no"

  # Run Thunder server with the shared database
  thunder:
    image: ghcr.io/asgardeo/thunder:0.14.0
    container_name: thunder-server
    depends_on:
      thunder-setup:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:8090:8090"
    volumes:
      - thunder-db:/opt/thunder/repository/database
      - ../../../services/silver-config/thunder/certs/server.cert:/opt/thunder/repository/resources/security/server.cert:ro
      - ../../../services/silver-config/thunder/certs/server.key:/opt/thunder/repository/resources/security/server.key:ro
    networks:
      - mail-network
    restart: unless-stopped

volumes:
  thunder-db:
    driver: local

networks:
  mail-network:
    external: true