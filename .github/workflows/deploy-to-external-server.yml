name: Deploy to External Server

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'scripts/**'
      - 'conf/**'
  pull_request:
    paths:
      - 'services/**'
      - 'scripts/**'
      - 'conf/**'
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  # These should be set in GitHub Secrets or repository variables
  # Authentication Method 1: SSH Key (Recommended)
  # EXTERNAL_SERVER_HOST: Set this in GitHub repository settings
  # EXTERNAL_SERVER_USER: Set this in GitHub repository settings
  # EXTERNAL_SERVER_SSH_KEY: Set this in GitHub Secrets
  # EXTERNAL_SERVER_PORT: Set this in GitHub repository settings (default: 22)
  #
  # Authentication Method 2: Password (Less secure, but simpler)
  # EXTERNAL_SERVER_HOST: Set this in GitHub repository settings
  # EXTERNAL_SERVER_USER: Set this in GitHub repository settings (e.g., root)
  # EXTERNAL_SERVER_PASSWORD: Set this in GitHub Secrets
  # EXTERNAL_SERVER_PORT: Set this in GitHub repository settings (default: 22)
  DEPLOY_PATH: /opt/silver

jobs:
  check-connection-vars:
    name: Check External Server Configuration
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.enabled }}
      auth_method: ${{ steps.check.outputs.auth_method }}
    steps:
      - name: Check if external server variables are set
        id: check
        env:
          SERVER_HOST: ${{ secrets.EXTERNAL_SERVER_HOST }}
          SERVER_USER: ${{ secrets.EXTERNAL_SERVER_USER }}
          SERVER_KEY: ${{ secrets.EXTERNAL_SERVER_SSH_KEY }}
          SERVER_PASSWORD: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
        run: |
          if [[ -n "$SERVER_HOST" ]] && [[ -n "$SERVER_USER" ]]; then
            if [[ -n "$SERVER_KEY" ]]; then
              echo "enabled=true" >> $GITHUB_OUTPUT
              echo "auth_method=key" >> $GITHUB_OUTPUT
              echo "âœ… External server deployment is configured (SSH Key authentication)"
            elif [[ -n "$SERVER_PASSWORD" ]]; then
              echo "enabled=true" >> $GITHUB_OUTPUT
              echo "auth_method=password" >> $GITHUB_OUTPUT
              echo "âœ… External server deployment is configured (Password authentication)"
            else
              echo "enabled=false" >> $GITHUB_OUTPUT
              echo "âš ï¸  External server deployment is not configured (missing authentication)"
              echo "To enable external server deployment, set the following secrets:"
              echo "  - EXTERNAL_SERVER_HOST"
              echo "  - EXTERNAL_SERVER_USER (e.g., root)"
              echo "  And either:"
              echo "    - EXTERNAL_SERVER_SSH_KEY (recommended)"
              echo "    OR"
              echo "    - EXTERNAL_SERVER_PASSWORD (simpler but less secure)"
              echo "  - EXTERNAL_SERVER_PORT (optional, defaults to 22)"
            fi
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  External server deployment is not configured (missing host/user)"
          fi

  check-silver-folder:
    name: Check Silver Folder Exists
    needs: check-connection-vars
    if: needs.check-connection-vars.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.target_environment || 'production' }}
    
    steps:
      - name: Install sshpass (for password authentication)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          echo "âœ… sshpass installed"

      - name: Setup SSH (Key-based authentication)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EXTERNAL_SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} -H ${{ secrets.EXTERNAL_SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… Added server to known hosts"

      - name: Check silver folder and run get-dkim.sh (Key-based)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        run: |
          ssh -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} << 'ENDSSH'
            if [ -d "${{ env.DEPLOY_PATH }}" ]; then
              echo "âœ… Silver folder exists at ${{ env.DEPLOY_PATH }}"
              cd ${{ env.DEPLOY_PATH }}/scripts/utils
              echo "ðŸ“‚ Running get-dkim.sh from $(pwd)"
              bash get-dkim.sh
            else
              echo "âŒ Silver folder does not exist at ${{ env.DEPLOY_PATH }}"
              exit 1
            fi
          ENDSSH

      - name: Check silver folder and run get-dkim.sh (Password-based)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        env:
          SSHPASS: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} << 'ENDSSH'
            if [ -d "${{ env.DEPLOY_PATH }}" ]; then
              echo "âœ… Silver folder exists at ${{ env.DEPLOY_PATH }}"
              cd ${{ env.DEPLOY_PATH }}/scripts/utils
              echo "ðŸ“‚ Running get-dkim.sh from $(pwd)"
              bash get-dkim.sh
            else
              echo "âŒ Silver folder does not exist at ${{ env.DEPLOY_PATH }}"
              exit 1
            fi
          ENDSSH
