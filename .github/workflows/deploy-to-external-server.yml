name: Deploy to External Server

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'scripts/**'
      - 'conf/**'
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  # These should be set in GitHub Secrets or repository variables
  # Authentication Method 1: SSH Key (Recommended)
  # EXTERNAL_SERVER_HOST: Set this in GitHub repository settings
  # EXTERNAL_SERVER_USER: Set this in GitHub repository settings
  # EXTERNAL_SERVER_SSH_KEY: Set this in GitHub Secrets
  # EXTERNAL_SERVER_PORT: Set this in GitHub repository settings (default: 22)
  #
  # Authentication Method 2: Password (Less secure, but simpler)
  # EXTERNAL_SERVER_HOST: Set this in GitHub repository settings
  # EXTERNAL_SERVER_USER: Set this in GitHub repository settings (e.g., root)
  # EXTERNAL_SERVER_PASSWORD: Set this in GitHub Secrets
  # EXTERNAL_SERVER_PORT: Set this in GitHub repository settings (default: 22)
  DEPLOY_PATH: /opt/silver

jobs:
  check-connection-vars:
    name: Check External Server Configuration
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.enabled }}
      auth_method: ${{ steps.check.outputs.auth_method }}
    steps:
      - name: Check if external server variables are set
        id: check
        env:
          SERVER_HOST: ${{ secrets.EXTERNAL_SERVER_HOST }}
          SERVER_USER: ${{ secrets.EXTERNAL_SERVER_USER }}
          SERVER_KEY: ${{ secrets.EXTERNAL_SERVER_SSH_KEY }}
          SERVER_PASSWORD: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
        run: |
          if [[ -n "$SERVER_HOST" ]] && [[ -n "$SERVER_USER" ]]; then
            if [[ -n "$SERVER_KEY" ]]; then
              echo "enabled=true" >> $GITHUB_OUTPUT
              echo "auth_method=key" >> $GITHUB_OUTPUT
              echo "‚úÖ External server deployment is configured (SSH Key authentication)"
            elif [[ -n "$SERVER_PASSWORD" ]]; then
              echo "enabled=true" >> $GITHUB_OUTPUT
              echo "auth_method=password" >> $GITHUB_OUTPUT
              echo "‚úÖ External server deployment is configured (Password authentication)"
            else
              echo "enabled=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è  External server deployment is not configured (missing authentication)"
              echo "To enable external server deployment, set the following secrets:"
              echo "  - EXTERNAL_SERVER_HOST"
              echo "  - EXTERNAL_SERVER_USER (e.g., root)"
              echo "  And either:"
              echo "    - EXTERNAL_SERVER_SSH_KEY (recommended)"
              echo "    OR"
              echo "    - EXTERNAL_SERVER_PASSWORD (simpler but less secure)"
              echo "  - EXTERNAL_SERVER_PORT (optional, defaults to 22)"
            fi
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  External server deployment is not configured (missing host/user)"
          fi

  deploy-to-external-server:
    name: Deploy to External Server
    needs: check-connection-vars
    if: needs.check-connection-vars.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.target_environment || 'production' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install sshpass (for password authentication)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          echo "‚úÖ sshpass installed"

      - name: Setup SSH (Key-based authentication)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EXTERNAL_SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} -H ${{ secrets.EXTERNAL_SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "‚úÖ Added server to known hosts"

      - name: Test SSH connection (Key-based)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        run: |
          ssh -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} \
              'echo "‚úÖ SSH connection successful (Key-based)"'

      - name: Test SSH connection (Password-based)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        env:
          SSHPASS: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} \
              'echo "‚úÖ SSH connection successful (Password-based)"'

      - name: Create deployment directory on remote server (Key-based)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        run: |
          ssh -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} \
              "mkdir -p ${{ env.DEPLOY_PATH }} && echo '‚úÖ Deployment directory created'"

      - name: Create deployment directory on remote server (Password-based)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        env:
          SSHPASS: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} \
              "mkdir -p ${{ env.DEPLOY_PATH }} && echo '‚úÖ Deployment directory created'"

      - name: Sync files to external server (Key-based)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        run: |
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }}" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '*.log' \
            --exclude 'services/letsencrypt/certbot-logs' \
            ./ ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
          echo "‚úÖ Files synced successfully"

      - name: Sync files to external server (Password-based)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        env:
          SSHPASS: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
        run: |
          rsync -avz --delete \
            -e "sshpass -e ssh -o StrictHostKeyChecking=no -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }}" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '*.log' \
            --exclude 'services/letsencrypt/certbot-logs' \
            ./ ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
          echo "‚úÖ Files synced successfully"

      - name: Update configuration on remote server (Key-based)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        env:
          CONFIG_TOKEN: ${{ secrets.CONFIG_REPO_TOKEN }}
        run: |
          ssh -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            # Set GitHub token for private repos if provided
            if [[ -n "${{ secrets.CONFIG_REPO_TOKEN }}" ]]; then
              git config --global credential.helper store
              echo "https://${{ secrets.CONFIG_REPO_TOKEN }}@github.com" > ~/.git-credentials
            fi
            
            echo "‚úÖ Configuration updated"
          ENDSSH

      - name: Update configuration on remote server (Password-based)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        env:
          SSHPASS: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
          CONFIG_TOKEN: ${{ secrets.CONFIG_REPO_TOKEN }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            # Set GitHub token for private repos if provided
            if [[ -n "${{ secrets.CONFIG_REPO_TOKEN }}" ]]; then
              git config --global credential.helper store
              echo "https://${{ secrets.CONFIG_REPO_TOKEN }}@github.com" > ~/.git-credentials
            fi
            
            echo "‚úÖ Configuration updated"
          ENDSSH

      - name: Restart services on remote server (Key-based)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        run: |
          ssh -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}/services
            
            # Check if Docker is available
            if command -v docker &> /dev/null && command -v docker-compose &> /dev/null; then
              echo "üîÑ Restarting Docker services..."
              docker-compose down
              docker-compose up -d
              echo "‚úÖ Services restarted successfully"
            else
              echo "‚ö†Ô∏è  Docker/Docker Compose not found. Skipping service restart."
              echo "Please restart services manually."
            fi
          ENDSSH

      - name: Restart services on remote server (Password-based)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        env:
          SSHPASS: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}/services
            
            # Check if Docker is available
            if command -v docker &> /dev/null && command -v docker-compose &> /dev/null; then
              echo "üîÑ Restarting Docker services..."
              docker-compose down
              docker-compose up -d
              echo "‚úÖ Services restarted successfully"
            else
              echo "‚ö†Ô∏è  Docker/Docker Compose not found. Skipping service restart."
              echo "Please restart services manually."
            fi
          ENDSSH

      - name: Verify deployment (Key-based)
        if: needs.check-connection-vars.outputs.auth_method == 'key'
        run: |
          ssh -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            echo "üìã Deployment verification:"
            echo "   - Commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'N/A')"
            echo "   - Branch: $(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'N/A')"
            echo "   - Deploy path: ${{ env.DEPLOY_PATH }}"
            
            if command -v docker &> /dev/null; then
              echo ""
              echo "üê≥ Running Docker containers:"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            fi
            
            echo "‚úÖ Deployment complete!"
          ENDSSH

      - name: Verify deployment (Password-based)
        if: needs.check-connection-vars.outputs.auth_method == 'password'
        env:
          SSHPASS: ${{ secrets.EXTERNAL_SERVER_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.EXTERNAL_SERVER_PORT || '22' }} \
              ${{ secrets.EXTERNAL_SERVER_USER }}@${{ secrets.EXTERNAL_SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            echo "üìã Deployment verification:"
            echo "   - Commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'N/A')"
            echo "   - Branch: $(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'N/A')"
            echo "   - Deploy path: ${{ env.DEPLOY_PATH }}"
            
            if command -v docker &> /dev/null; then
              echo ""
              echo "üê≥ Running Docker containers:"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            fi
            
            echo "‚úÖ Deployment complete!"
          ENDSSH

      - name: Deployment summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ secrets.EXTERNAL_SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **User:** ${{ secrets.EXTERNAL_SERVER_USER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.target_environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Path:** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  notify-on-failure:
    name: Notify on Deployment Failure
    needs: deploy-to-external-server
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send failure notification
        run: |
          echo "‚ùå Deployment to external server failed!"
          echo "Please check the logs for details."
          # Add your notification logic here (Slack, email, etc.)
